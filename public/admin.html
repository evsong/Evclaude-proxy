<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Claude API 代理 - 管理后台</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/vue@3.3.0/dist/vue.global.prod.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/axios@1.6.0/dist/axios.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    .sidebar {
      min-height: 100vh;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }
    .navbar-brand {
      font-size: 1.5rem;
      font-weight: bold;
    }
    .card-stats {
      transition: transform 0.3s;
    }
    .card-stats:hover {
      transform: translateY(-5px);
    }
    .stat-value {
      font-size: 2.5rem;
      font-weight: bold;
    }
    .loading {
      display: flex;
      justify-content: center;
      align-items: center;
      height: 200px;
    }
    .sidebar .nav-link {
      color: rgba(255,255,255,0.8);
      transition: all 0.3s;
    }
    .sidebar .nav-link:hover,
    .sidebar .nav-link.active {
      color: white;
      background: rgba(255,255,255,0.1);
    }
  </style>
</head>
<body>
  <div id="app">
    <!-- 侧边栏 -->
    <div class="container-fluid">
      <div class="row">
        <nav class="col-md-3 col-lg-2 d-md-block sidebar collapse">
          <div class="position-sticky pt-3">
            <div class="navbar-brand text-white mb-4 text-center">
              <i class="bi bi-cloud-arrow-up"></i> Claude Proxy
            </div>
            <ul class="nav flex-column">
              <li class="nav-item">
                <a class="nav-link" :class="{active: currentView === 'dashboard'}" href="#" @click="currentView = 'dashboard'">
                  <i class="bi bi-speedometer2"></i> 仪表盘
                </a>
              </li>
              <li class="nav-item">
                <a class="nav-link" :class="{active: currentView === 'users'}" href="#" @click="currentView = 'users'" v-if="user.role === 'admin'">
                  <i class="bi bi-people"></i> 用户管理
                </a>
              </li>
              <li class="nav-item">
                <a class="nav-link" :class="{active: currentView === 'keys'}" href="#" @click="currentView = 'keys'">
                  <i class="bi bi-key"></i> API Keys
                </a>
              </li>
              <li class="nav-item">
                <a class="nav-link" :class="{active: currentView === 'logs'}" href="#" @click="currentView = 'logs'" v-if="user.role === 'admin'">
                  <i class="bi bi-file-text"></i> 请求日志
                </a>
              </li>
              <li class="nav-item">
                <a class="nav-link" :class="{active: currentView === 'config'}" href="#" @click="currentView = 'config'" v-if="user.role === 'admin'">
                  <i class="bi bi-gear"></i> 系统配置
                </a>
              </li>
              <li class="nav-item mt-4">
                <a class="nav-link text-danger" href="#" @click="logout">
                  <i class="bi bi-box-arrow-right"></i> 退出登录
                </a>
              </li>
            </ul>
          </div>
        </nav>

        <!-- 主内容区 -->
        <main class="col-md-9 ms-sm-auto col-lg-10 px-md-4">
          <!-- 顶部导航 -->
          <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
            <h1 class="h2">{{ getPageTitle() }}</h1>
            <div class="btn-toolbar mb-2 mb-md-0">
              <span class="badge bg-primary me-2">{{ user.role }}</span>
              <span class="text-muted">{{ user.username }}</span>
            </div>
          </div>

          <!-- 仪表盘 -->
          <div v-if="currentView === 'dashboard'">
            <div class="row g-4 mb-4">
              <div class="col-xl-3 col-md-6">
                <div class="card card-stats text-white" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                  <div class="card-body">
                    <h6 class="card-title">总请求数</h6>
                    <div class="stat-value">{{ stats.totalRequests?.toLocaleString() || 0 }}</div>
                  </div>
                </div>
              </div>
              <div class="col-xl-3 col-md-6">
                <div class="card card-stats text-white" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);">
                  <div class="card-body">
                    <h6 class="card-title">今日请求</h6>
                    <div class="stat-value">{{ stats.todayRequests?.toLocaleString() || 0 }}</div>
                  </div>
                </div>
              </div>
              <div class="col-xl-3 col-md-6">
                <div class="card card-stats text-white" style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);">
                  <div class="card-body">
                    <h6 class="card-title">成功率</h6>
                    <div class="stat-value">{{ getSuccessRate() }}%</div>
                  </div>
                </div>
              </div>
              <div class="col-xl-3 col-md-6">
                <div class="card card-stats text-white" style="background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);">
                  <div class="card-body">
                    <h6 class="card-title">总 Token</h6>
                    <div class="stat-value">{{ stats.totalTokens?.toLocaleString() || 0 }}</div>
                  </div>
                </div>
              </div>
            </div>

            <!-- 图表区域 -->
            <div class="row">
              <div class="col-12">
                <div class="card">
                  <div class="card-header">
                    <h5 class="mb-0">24小时请求分布</h5>
                  </div>
                  <div class="card-body">
                    <canvas id="hourlyChart" height="100"></canvas>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- 用户管理 -->
          <div v-if="currentView === 'users' && user.role === 'admin'">
            <div class="card">
              <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">用户列表</h5>
                <button class="btn btn-primary" @click="showCreateUser = true">
                  <i class="bi bi-plus-circle"></i> 创建用户
                </button>
              </div>
              <div class="card-body">
                <div class="table-responsive">
                  <table class="table table-striped">
                    <thead>
                      <tr>
                        <th>ID</th>
                        <th>用户名</th>
                        <th>邮箱</th>
                        <th>角色</th>
                        <th>状态</th>
                        <th>创建时间</th>
                        <th>操作</th>
                      </tr>
                    </thead>
                    <tbody>
                      <tr v-for="user in users" :key="user.id">
                        <td>{{ user.id }}</td>
                        <td>{{ user.username }}</td>
                        <td>{{ user.email }}</td>
                        <td><span class="badge bg-info">{{ user.role }}</span></td>
                        <td><span class="badge" :class="user.status === 'active' ? 'bg-success' : 'bg-danger'">{{ user.status }}</span></td>
                        <td>{{ formatDate(user.created_at) }}</td>
                        <td>
                          <button class="btn btn-sm btn-outline-primary">编辑</button>
                        </td>
                      </tr>
                    </tbody>
                  </table>
                </div>
              </div>
            </div>
          </div>

          <!-- API Keys -->
          <div v-if="currentView === 'keys'">
            <div class="card">
              <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">我的 API Keys</h5>
                <button class="btn btn-primary" @click="showCreateKey = true">
                  <i class="bi bi-plus-circle"></i> 生成新 Key
                </button>
              </div>
              <div class="card-body">
                <div class="table-responsive">
                  <table class="table table-striped">
                    <thead>
                      <tr>
                        <th>名称</th>
                        <th>API Key</th>
                        <th>速率限制</th>
                        <th>使用次数</th>
                        <th>最后使用</th>
                        <th>状态</th>
                        <th>操作</th>
                      </tr>
                    </thead>
                    <tbody>
                      <tr v-for="key in apiKeys" :key="key.id">
                        <td>{{ key.name }}</td>
                        <td><code>{{ key.key.substring(0, 20) }}...</code></td>
                        <td>{{ key.rateLimit }}/小时</td>
                        <td>{{ key.usage_count }}</td>
                        <td>{{ key.last_used ? formatDate(key.last_used) : '未使用' }}</td>
                        <td><span class="badge" :class="key.status === 'active' ? 'bg-success' : 'bg-danger'">{{ key.status }}</span></td>
                        <td>
                          <button class="btn btn-sm btn-outline-danger" @click="deleteKey(key.id)">删除</button>
                        </td>
                      </tr>
                    </tbody>
                  </table>
                </div>
              </div>
            </div>
            <div class="card mt-3" v-if="tokenUsageTable.length">
              <div class="card-header">
                <h5 class="mb-0">Token 用量统计</h5>
              </div>
              <div class="card-body">
                <div class="table-responsive">
                  <table class="table table-striped">
                    <thead>
                      <tr>
                        <th>名称</th>
                        <th>Token</th>
                        <th>请求数</th>
                        <th>Tokens</th>
                        <th>最后使用</th>
                      </tr>
                    </thead>
                    <tbody>
                      <tr v-for="item in tokenUsageTable" :key="item.id">
                        <td>{{ item.name }}</td>
                        <td><code>{{ item.masked }}</code></td>
                        <td>{{ item.requests || 0 }}</td>
                        <td>{{ item.tokens || 0 }}</td>
                        <td>{{ item.lastUsed ? formatDate(item.lastUsed) : '未使用' }}</td>
                      </tr>
                    </tbody>
                  </table>
                </div>
              </div>
            </div>
          </div>

          <!-- 请求日志 -->
          <div v-if="currentView === 'logs' && user.role === 'admin'">
            <div class="card">
              <div class="card-header">
                <h5 class="mb-0">请求日志</h5>
              </div>
              <div class="card-body">
                <div class="table-responsive">
                  <table class="table table-striped table-sm">
                    <thead>
                      <tr>
                        <th>时间</th>
                        <th>用户</th>
                        <th>Key</th>
                        <th>方法</th>
                        <th>路径</th>
                        <th>状态码</th>
                        <th>响应时间</th>
                        <th>IP</th>
                        <th>内容</th>
                      </tr>
                    </thead>
                    <tbody>
                      <tr v-for="log in logs" :key="log.id">
                        <td>{{ formatDate(log.timestamp) }}</td>
                        <td>{{ log.userId || '-' }}</td>
                        <td>{{ log.keyName || log.apiKey || '-' }}</td>
                        <td>{{ log.method }}</td>
                        <td>{{ log.path }}</td>
                        <td><span class="badge" :class="log.statusCode < 400 ? 'bg-success' : 'bg-danger'">{{ log.statusCode }}</span></td>
                        <td>{{ log.responseTime }}ms</td>
                        <td>{{ log.ip }}</td>
                        <td><button class="btn btn-sm btn-outline-secondary" @click="openLog(log)">查看</button></td>
                      </tr>
                    </tbody>
                  </table>
                </div>
              </div>
            </div>
          </div>

          <!-- 系统配置 -->
          <div v-if="currentView === 'config' && user.role === 'admin'">
            <div class="card">
              <div class="card-header">
                <h5 class="mb-0">系统配置</h5>
              </div>
              <div class="card-body">
                <form @submit.prevent="saveConfig">
                  <div class="mb-3">
                    <label class="form-label">站点名称</label>
                    <input type="text" class="form-control" v-model="config.siteName">
                  </div>
                  <div class="mb-3">
                    <label class="form-label">默认速率限制（请求/小时）</label>
                    <input type="number" class="form-control" v-model="config.defaultRateLimit">
                  </div>
                  <div class="mb-3">
                    <label class="form-label">输入 Token 价格（每千个）</label>
                    <input type="number" step="0.001" class="form-control" v-model="config.pricing.inputTokenPrice">
                  </div>
                  <div class="mb-3">
                    <label class="form-label">输出 Token 价格（每千个）</label>
                    <input type="number" step="0.001" class="form-control" v-model="config.pricing.outputTokenPrice">
                  </div>
                  <div class="mb-3 form-check">
                    <input type="checkbox" class="form-check-input" v-model="config.maintenance">
                    <label class="form-check-label">维护模式</label>
                  </div>
                  <div class="mb-3 form-check">
                    <input type="checkbox" class="form-check-input" v-model="config.registrationEnabled">
                    <label class="form-check-label">允许用户注册</label>
                  </div>
                  <button type="submit" class="btn btn-primary">保存配置</button>
                </form>
              </div>
            </div>
          </div>
        </main>
      </div>
    </div>

    <!-- 创建用户模态框 -->
    <div class="modal fade" :class="{show: showCreateUser}" style="display: block;" v-if="showCreateUser">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">创建新用户</h5>
            <button type="button" class="btn-close" @click="showCreateUser = false"></button>
          </div>
          <div class="modal-body">
            <form @submit.prevent="createUser">
              <div class="mb-3">
                <label class="form-label">用户名</label>
                <input type="text" class="form-control" v-model="newUser.username" required>
              </div>
              <div class="mb-3">
                <label class="form-label">密码</label>
                <input type="password" class="form-control" v-model="newUser.password" required>
              </div>
              <div class="mb-3">
                <label class="form-label">邮箱</label>
                <input type="email" class="form-control" v-model="newUser.email" required>
              </div>
              <div class="mb-3">
                <label class="form-label">角色</label>
                <select class="form-select" v-model="newUser.role">
                  <option value="user">普通用户</option>
                  <option value="admin">管理员</option>
                </select>
              </div>
              <button type="submit" class="btn btn-primary">创建</button>
            </form>
          </div>
        </div>
      </div>
    </div>

    <!-- 生成 API Key 模态框 -->
    <div class="modal fade" :class="{show: showCreateKey}" style="display: block;" v-if="showCreateKey">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">生成新的 API Key</h5>
            <button type="button" class="btn-close" @click="showCreateKey = false"></button>
          </div>
          <div class="modal-body">
            <form @submit.prevent="generateKey">
              <div class="mb-3">
                <label class="form-label">名称</label>
                <input type="text" class="form-control" v-model="newKey.name" required>
              </div>
              <div class="mb-3">
                <label class="form-label">速率限制（请求/小时）</label>
                <input type="number" class="form-control" v-model="newKey.rateLimit">
              </div>
              <button type="submit" class="btn btn-primary">生成</button>
            </form>
          </div>
        </div>
      </div>
    </div>

    <!-- 日志详情模态框 -->
    <div class="modal fade" :class="{show: showLogModal}" style="display: block;" v-if="showLogModal">
      <div class="modal-dialog modal-lg">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">日志详情</h5>
            <button type="button" class="btn-close" @click="closeLogModal"></button>
          </div>
          <div class="modal-body" v-if="selectedLog">
            <p><strong>时间：</strong>{{ formatDate(selectedLog.timestamp) }}</p>
            <p><strong>Key：</strong>{{ selectedLog.keyName || selectedLog.apiKey || '-' }}</p>
            <p><strong>路径：</strong>{{ selectedLog.path }}</p>
            <p><strong>状态码：</strong>{{ selectedLog.statusCode }}</p>
            <p><strong>请求体：</strong></p>
            <pre class="bg-light p-2" style="white-space: pre-wrap;">{{ selectedLog.requestBody || '(无)' }}</pre>
            <p><strong>响应体：</strong></p>
            <pre class="bg-light p-2" style="white-space: pre-wrap;">{{ selectedLog.responseBody || '(无)' }}</pre>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" @click="closeLogModal">关闭</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    const { createApp } = Vue;

    createApp({
      data() {
        return {
          currentView: 'dashboard',
          user: {},
          token: localStorage.getItem('token'),
          stats: {},
          users: [],
          apiKeys: [],
          logs: [],
          config: {
            siteName: '',
            defaultRateLimit: 1000,
            pricing: {
              inputTokenPrice: 0.003,
              outputTokenPrice: 0.015
            },
            maintenance: false,
            registrationEnabled: true
          },
          showCreateUser: false,
          showCreateKey: false,
          newUser: {
            username: '',
            password: '',
            email: '',
            role: 'user'
          },
          newKey: {
            name: '',
            rateLimit: 1000
          },
          selectedLog: null,
          showLogModal: false
          }
        };
      },
      computed: {
        tokenUsageTable() {
          if (!this.stats.tokenStats) return [];
          return Object.entries(this.stats.tokenStats).map(([id, item]) => ({
            id,
            ...item
          })).sort((a, b) => (b.requests || 0) - (a.requests || 0));
        }
      },
      mounted() {
        if (!this.token) {
          window.location.href = '/login.html';
          return;
        }
        this.verifyToken();
        this.loadStats();
        setInterval(() => {
          this.loadStats();
        }, 5000);
      },
      methods: {
        async verifyToken() {
          try {
            const res = await axios.get('/api/auth/verify', {
              headers: { Authorization: `Bearer ${this.token}` }
            });
            this.user = res.data.user;
            this.loadUsers();
            this.loadApiKeys();
            this.loadLogs();
            this.loadConfig();
          } catch (error) {
            this.logout();
          }
        },
        async loadStats() {
          try {
            const res = await axios.get('/api/stats', {
              headers: { Authorization: `Bearer ${this.token}` }
            });
            this.stats = res.data;
            this.$nextTick(() => {
              this.renderChart();
            });
          } catch (error) {
            console.error('加载统计数据失败:', error);
          }
        },
        async loadUsers() {
          if (this.user.role !== 'admin') return;
          try {
            const res = await axios.get('/api/users', {
              headers: { Authorization: `Bearer ${this.token}` }
            });
            this.users = res.data.users;
          } catch (error) {
            console.error('加载用户列表失败:', error);
          }
        },
        async loadApiKeys() {
          try {
            const res = await axios.get('/api/keys', {
              headers: { Authorization: `Bearer ${this.token}` }
            });
            this.apiKeys = res.data.keys;
          } catch (error) {
            console.error('加载 API Keys 失败:', error);
          }
        },
        async loadLogs() {
          if (this.user.role !== 'admin') return;
          try {
            const res = await axios.get('/api/logs', {
              headers: { Authorization: `Bearer ${this.token}` }
            });
            this.logs = res.data.logs;
          } catch (error) {
            console.error('加载日志失败:', error);
          }
        },
        openLog(log) {
          this.selectedLog = log;
          this.showLogModal = true;
        },
        closeLogModal() {
          this.showLogModal = false;
          this.selectedLog = null;
        },
        async loadConfig() {
          if (this.user.role !== 'admin') return;
          try {
            const res = await axios.get('/api/config', {
              headers: { Authorization: `Bearer ${this.token}` }
            });
            this.config = res.data;
          } catch (error) {
            console.error('加载配置失败:', error);
          }
        },
        async createUser() {
          try {
            await axios.post('/api/users', this.newUser, {
              headers: { Authorization: `Bearer ${this.token}` }
            });
            this.showCreateUser = false;
            this.newUser = { username: '', password: '', email: '', role: 'user' };
            this.loadUsers();
            alert('用户创建成功');
          } catch (error) {
            alert('创建失败: ' + error.response?.data?.error);
          }
        },
        async generateKey() {
          try {
            await axios.post('/api/keys/generate', this.newKey, {
              headers: { Authorization: `Bearer ${this.token}` }
            });
            this.showCreateKey = false;
            this.newKey = { name: '', rateLimit: 1000 };
            this.loadApiKeys();
            alert('API Key 生成成功');
          } catch (error) {
            alert('生成失败: ' + error.response?.data?.error);
          }
        },
        async saveConfig() {
          try {
            await axios.put('/api/config', this.config, {
              headers: { Authorization: `Bearer ${this.token}` }
            });
            alert('配置保存成功');
          } catch (error) {
            alert('保存失败: ' + error.response?.data?.error);
          }
        },
        deleteKey(keyId) {
          if (confirm('确定要删除这个 API Key 吗？')) {
            // 实现删除逻辑
            alert('删除功能待实现');
          }
        },
        logout() {
          localStorage.removeItem('token');
          window.location.href = '/login.html';
        },
        getPageTitle() {
          const titles = {
            dashboard: '仪表盘',
            users: '用户管理',
            keys: 'API Keys',
            logs: '请求日志',
            config: '系统配置'
          };
          return titles[this.currentView] || '管理后台';
        },
        formatDate(dateStr) {
          if (!dateStr) return '-';
          return new Date(dateStr).toLocaleString('zh-CN');
        },
        getSuccessRate() {
          if (!this.stats.totalRequests) return 0;
          return Math.round((this.stats.successfulRequests / this.stats.totalRequests) * 100);
        },
        renderChart() {
          const ctx = document.getElementById('hourlyChart');
          if (!ctx) return;

          const hours = Array.from({length: 24}, (_, i) => `${i}:00`);
          const requests = Array.from({length: 24}, (_, i) => {
            return this.stats.hourlyStats[i]?.requests || 0;
          });

          new Chart(ctx, {
            type: 'line',
            data: {
              labels: hours,
              datasets: [{
                label: '请求数',
                data: requests,
                borderColor: '#667eea',
                backgroundColor: 'rgba(102, 126, 234, 0.1)',
                tension: 0.4
              }]
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              plugins: {
                legend: { display: false }
              },
              scales: {
                y: { beginAtZero: true }
              }
            }
          });
        }
      }
    }).mount('#app');

    // 设置 axios 默认请求头
    axios.defaults.baseURL = '';
  </script>
</body>
</html>
